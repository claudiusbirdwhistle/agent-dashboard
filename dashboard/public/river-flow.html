<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>US River Flow Trends — A Century of Hydrological Change</title>
<style>
  :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --text: #e6edf3; --dim: #8b949e; --accent: #58a6ff; --green: #3fb950; --yellow: #d29922; --red: #f85149; --purple: #bc8cff; --cyan: #39d2c0; --pink: #f778ba; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; }
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header h1 span { color: var(--dim); font-weight: 400; font-size: 13px; margin-left: 8px; }
  .header-nav { display: flex; gap: 8px; flex-wrap: wrap; }
  .header-nav a { font-size: 12px; color: var(--accent); text-decoration: none; padding: 4px 10px; border: 1px solid var(--border); border-radius: 6px; }
  .header-nav a:hover { background: rgba(88,166,255,0.1); }
  .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
  .loading { text-align: center; padding: 60px; color: var(--dim); }
  .error { text-align: center; padding: 60px; color: var(--red); }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .stat-card .label { font-size: 11px; color: var(--dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .stat-card .value { font-size: 22px; font-weight: 600; color: var(--accent); }
  .stat-card .value.green { color: var(--green); }
  .stat-card .value.red { color: var(--red); }
  .stat-card .value.yellow { color: var(--yellow); }
  .stat-card .detail { font-size: 11px; color: var(--dim); margin-top: 4px; }
  .section { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px; overflow: hidden; }
  .section-header { padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .section-header:hover { background: rgba(88,166,255,0.04); }
  .section-header h2 { font-size: 15px; font-weight: 600; }
  .section-header .toggle { color: var(--dim); font-size: 12px; }
  .section-body { display: none; padding: 0 18px 18px; }
  .section.open .section-body { display: block; }
  .section.open .toggle::after { content: '▲'; }
  .section:not(.open) .toggle::after { content: '▼'; }
  table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 13px; }
  th { text-align: left; padding: 8px 10px; border-bottom: 2px solid var(--border); color: var(--dim); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
  tr:hover td { background: rgba(88,166,255,0.04); }
  .bar-container { display: flex; align-items: center; gap: 8px; }
  .bar { height: 12px; border-radius: 3px; min-width: 2px; }
  .bar.positive { background: var(--green); }
  .bar.negative { background: var(--red); }
  .bar-label { font-size: 12px; min-width: 60px; }
  .finding { background: rgba(88,166,255,0.05); border-left: 3px solid var(--accent); padding: 12px 16px; margin: 12px 0; border-radius: 0 6px 6px 0; }
  .finding strong { color: var(--accent); }
  .finding p { margin-top: 4px; color: var(--dim); font-size: 13px; }
  .report-link { display: inline-block; margin-top: 16px; padding: 8px 16px; background: rgba(88,166,255,0.1); border: 1px solid var(--accent); border-radius: 6px; color: var(--accent); text-decoration: none; font-size: 13px; }
  .report-link:hover { background: rgba(88,166,255,0.2); }
</style>
</head>
<body>
<div class="header">
  <h1>US River Flow Trends <span>A Century of Hydrological Change</span></h1>
  <div class="header-nav">
    <a href="/" id="home-link">Dashboard</a>
    <a href="/climate" id="climate-link">Climate Trends</a>
    <a href="/ocean-warming" id="ocean-link">Ocean Warming</a>
    <a href="/sea-level" id="sea-link">Sea Level</a>
  </div>
</div>

<div class="container">
  <div id="content"><div class="loading">Loading river flow data...</div></div>
</div>

<script>
const TOKEN = '__TOKEN__';
function ap(u) { return TOKEN ? u + (u.includes('?') ? '&' : '?') + 'token=' + TOKEN : u; }

// Fix nav links
document.querySelectorAll('.header-nav a').forEach(a => { a.href = ap(a.getAttribute('href')); });

async function init() {
  try {
    const r = await fetch(ap('/api/river-flow/summary'));
    if (!r.ok) throw new Error('Failed to load data');
    const d = await r.json();
    render(d);
  } catch(e) {
    document.getElementById('content').innerHTML = '<div class="error">Error loading data: ' + e.message + '</div>';
  }
}

function render(d) {
  const kf = d.key_findings || {};
  const stations = d.stations || [];

  // Count stats
  const declining = stations.filter(s => s.flow_trend_significant && s.flow_trend_pct_decade < 0);
  const increasing = stations.filter(s => s.flow_trend_significant && s.flow_trend_pct_decade > 0);
  const varDecline = stations.filter(s => s.cv_trend_pct_decade < 0).length;

  let html = '';

  // Stats cards
  html += '<div class="stats-grid">';
  html += card('Rivers Analyzed', stations.length, '', 'Total daily records: ' + (d.total_records||418591).toLocaleString());
  html += card('Declining (West)', declining.length, 'red', declining.map(s=>s.river).join(', '));
  html += card('Increasing (East)', increasing.length, 'green', increasing.map(s=>s.river).join(', '));
  html += card('Variability Declining', varDecline + '/10', 'yellow', 'Dam regulation smoothing flows');
  html += card('Record Span', '89-146 yr', '', 'Columbia longest (1880-2025)');
  html += card('Worst Droughts', 'All pre-1970', 'red', 'Infrastructure masks natural signal');
  html += '</div>';

  // Flow trends section
  html += section('Flow Trends — The East-West Divide', true, () => {
    let s = '<p style="color:var(--dim);margin-bottom:12px;">Annual mean flow trends over the full record period. Bold = statistically significant (Mann-Kendall, p&lt;0.05).</p>';
    s += '<table><tr><th>River</th><th>Basin</th><th>Years</th><th>Trend (%/decade)</th><th></th><th>Significant</th></tr>';
    const sorted = [...stations].sort((a,b) => a.flow_trend_pct_decade - b.flow_trend_pct_decade);
    const maxAbs = Math.max(...sorted.map(s => Math.abs(s.flow_trend_pct_decade)));
    sorted.forEach(r => {
      const pct = r.flow_trend_pct_decade;
      const sig = r.flow_trend_significant;
      const w = Math.round(Math.abs(pct) / maxAbs * 100);
      const cls = pct < 0 ? 'negative' : 'positive';
      const bold = sig ? 'font-weight:600;' : '';
      s += `<tr><td style="${bold}">${r.river}</td><td style="color:var(--dim)">${r.basin}</td><td>${r.years}</td>`;
      s += `<td style="${bold}color:${pct<0?'var(--red)':'var(--green)'}">${pct>0?'+':''}${pct.toFixed(1)}%</td>`;
      s += `<td><div class="bar-container"><div class="bar ${cls}" style="width:${w}px"></div></div></td>`;
      s += `<td>${sig ? '&#10003;' : ''}</td></tr>`;
    });
    s += '</table>';
    s += '<div class="finding"><strong>The East-West divide is the dominant pattern.</strong><p>All western rivers (Colorado, Columbia, Rio Grande) show significant declining flows. All central/eastern rivers (Mississippi, Missouri, Ohio) show significant increases. Consistent with climate models: wet regions get wetter, dry regions get drier.</p></div>';
    return s;
  });

  // Seasonal timing section
  html += section('Seasonal Timing — Snowmelt Shifts', false, () => {
    let s = '<p style="color:var(--dim);margin-bottom:12px;">Center timing: day of year when 50% of annual flow has passed. Negative shift = earlier peak (warming signal for snowmelt rivers).</p>';
    s += '<table><tr><th>River</th><th>Regime</th><th>Shift (days/decade)</th><th></th><th>Significant</th></tr>';
    stations.forEach(r => {
      const shift = r.seasonal_shift_days_decade;
      const sig = r.seasonal_shift_significant;
      const bold = sig ? 'font-weight:600;' : '';
      const dir = shift < 0 ? 'Earlier' : 'Later';
      const col = shift < 0 ? 'var(--cyan)' : 'var(--yellow)';
      s += `<tr><td style="${bold}">${r.river}</td><td style="color:var(--dim)">${r.regime}</td>`;
      s += `<td style="${bold}color:${col}">${shift>0?'+':''}${shift.toFixed(1)} (${dir})</td>`;
      const w = Math.min(Math.round(Math.abs(shift) * 15), 80);
      const cls = shift < 0 ? 'positive' : 'negative';
      s += `<td><div class="bar-container"><div class="bar" style="width:${w}px;background:${col}"></div></div></td>`;
      s += `<td>${sig ? '&#10003;' : ''}</td></tr>`;
    });
    s += '</table>';
    s += '<div class="finding"><strong>Yellowstone: the cleanest climate sentinel.</strong><p>As the longest undammed river in the lower 48, the Yellowstone shows peak flow arriving 0.8 days earlier per decade — a direct signature of warmer springs melting snowpack sooner.</p></div>';
    return s;
  });

  // Drought section
  html += section('Drought Analysis — Infrastructure vs. Nature', false, () => {
    let s = '<p style="color:var(--dim);margin-bottom:12px;">Q10 (10th percentile daily flow): the flow exceeded 90% of days. Rising Q10 = improving drought baseline.</p>';
    s += '<table><tr><th>River</th><th>Q10 Trend (%/dec)</th><th>Significant</th><th>Worst Drought Year</th></tr>';
    stations.forEach(r => {
      const q = r.q10_trend_pct_decade;
      const col = q > 0 ? 'var(--green)' : 'var(--red)';
      s += `<tr><td>${r.river}</td><td style="color:${col};font-weight:600">${q>0?'+':''}${q.toFixed(1)}%</td>`;
      s += `<td>${Math.abs(q) > 2 ? '&#10003;' : ''}</td><td>${r.worst_drought_year}</td></tr>`;
    });
    s += '</table>';
    s += '<div class="finding"><strong>A paradox: low flows are improving almost everywhere.</strong><p>9 of 10 rivers show increasing Q10. Dams guarantee minimum releases. All worst droughts occurred before 1970. The Yellowstone (undammed) is the only river showing natural drought worsening.</p></div>';
    return s;
  });

  // Variability section
  html += section('Flow Variability — The Smoothing Effect', false, () => {
    let s = '<p style="color:var(--dim);margin-bottom:12px;">Coefficient of variation (CV): how much daily flow varies within each year. Declining CV = smoother, more regulated flows.</p>';
    s += '<table><tr><th>River</th><th>CV Trend (%/dec)</th><th></th><th>Significant</th></tr>';
    const sorted = [...stations].sort((a,b) => a.cv_trend_pct_decade - b.cv_trend_pct_decade);
    sorted.forEach(r => {
      const cv = r.cv_trend_pct_decade;
      const sig = Math.abs(cv) > 1.5;
      const bold = sig ? 'font-weight:600;' : '';
      const col = cv < 0 ? 'var(--cyan)' : 'var(--yellow)';
      const w = Math.min(Math.round(Math.abs(cv) * 4), 80);
      s += `<tr><td style="${bold}">${r.river}</td><td style="${bold}color:${col}">${cv>0?'+':''}${cv.toFixed(1)}%</td>`;
      s += `<td><div class="bar-container"><div class="bar" style="width:${w}px;background:${col}"></div></div></td>`;
      s += `<td>${sig ? '&#10003;' : ''}</td></tr>`;
    });
    s += '</table>';
    s += '<div class="finding"><strong>Colorado: the most dramatic transformation.</strong><p>CV declined -19.0%/decade — dam regulation transformed a wildly variable desert river into a controlled water delivery system. This parallels the climate-trends finding that temperature volatility is also decreasing even as extremes intensify.</p></div>';
    return s;
  });

  // Report link
  html += '<a class="report-link" href="' + ap('/view/output/research/river-flow/report.md') + '">View Full Report</a>';

  document.getElementById('content').innerHTML = html;

  // Add click handlers for collapsible sections
  document.querySelectorAll('.section-header').forEach(h => {
    h.addEventListener('click', () => h.parentElement.classList.toggle('open'));
  });
}

function card(label, value, color, detail) {
  return `<div class="stat-card"><div class="label">${label}</div><div class="value ${color}">${value}</div>${detail ? `<div class="detail">${detail}</div>` : ''}</div>`;
}

function section(title, open, contentFn) {
  return `<div class="section ${open?'open':''}"><div class="section-header"><h2>${title}</h2><span class="toggle"></span></div><div class="section-body">${contentFn()}</div></div>`;
}

init();
</script>
</body>
</html>
