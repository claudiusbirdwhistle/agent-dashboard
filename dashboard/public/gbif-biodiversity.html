<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Global Biodiversity Observation Patterns â€” GBIF Analysis</title>
<style>
  :root { --bg: #0d1117; --surface: #161b22; --border: #30363d; --text: #e6edf3; --dim: #8b949e; --accent: #58a6ff; --green: #3fb950; --yellow: #d29922; --red: #f85149; --purple: #bc8cff; --cyan: #39d2c0; --pink: #f778ba; --orange: #f0883e; }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { background: var(--bg); color: var(--text); font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; font-size: 14px; line-height: 1.5; }
  .header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 12px 24px; display: flex; align-items: center; justify-content: space-between; }
  .header h1 { font-size: 18px; font-weight: 600; }
  .header h1 span { color: var(--dim); font-weight: 400; font-size: 13px; margin-left: 8px; }
  .header-nav { display: flex; gap: 8px; flex-wrap: wrap; }
  .header-nav a { font-size: 12px; color: var(--accent); text-decoration: none; padding: 4px 10px; border: 1px solid var(--border); border-radius: 6px; }
  .header-nav a:hover { background: rgba(88,166,255,0.1); }
  .container { max-width: 1200px; margin: 0 auto; padding: 24px; }
  .loading { text-align: center; padding: 60px; color: var(--dim); }
  .error { text-align: center; padding: 60px; color: var(--red); }
  .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 12px; margin-bottom: 24px; }
  .stat-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .stat-card .label { font-size: 11px; color: var(--dim); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
  .stat-card .value { font-size: 22px; font-weight: 600; color: var(--accent); }
  .stat-card .value.green { color: var(--green); }
  .stat-card .value.red { color: var(--red); }
  .stat-card .value.yellow { color: var(--yellow); }
  .stat-card .value.purple { color: var(--purple); }
  .stat-card .value.cyan { color: var(--cyan); }
  .stat-card .value.orange { color: var(--orange); }
  .stat-card .detail { font-size: 11px; color: var(--dim); margin-top: 4px; }

  .tabs { display: flex; gap: 0; margin-bottom: 24px; border-bottom: 1px solid var(--border); }
  .tab { padding: 10px 20px; cursor: pointer; color: var(--dim); font-size: 13px; font-weight: 500; border-bottom: 2px solid transparent; background: none; border-top: none; border-left: none; border-right: none; font-family: inherit; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-panel { display: none; }
  .tab-panel.active { display: block; }

  .section { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 16px; overflow: hidden; }
  .section-header { padding: 14px 18px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .section-header:hover { background: rgba(88,166,255,0.04); }
  .section-header h2 { font-size: 15px; font-weight: 600; }
  .section-header .toggle { color: var(--dim); font-size: 12px; }
  .section-body { display: none; padding: 0 18px 18px; }
  .section.open .section-body { display: block; }
  .section.open .toggle::after { content: '\u25B2'; }
  .section:not(.open) .toggle::after { content: '\u25BC'; }

  table { width: 100%; border-collapse: collapse; margin: 12px 0; font-size: 13px; }
  th { text-align: left; padding: 8px 10px; border-bottom: 2px solid var(--border); color: var(--dim); font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; }
  td { padding: 8px 10px; border-bottom: 1px solid var(--border); }
  tr:hover td { background: rgba(88,166,255,0.04); }

  .bar-container { display: flex; align-items: center; gap: 8px; }
  .bar { height: 14px; border-radius: 3px; min-width: 2px; transition: width 0.5s; }
  .bar-label { font-size: 12px; min-width: 50px; }

  .chart { position: relative; height: 250px; margin: 16px 0; border: 1px solid var(--border); border-radius: 6px; background: var(--bg); overflow: hidden; }
  .chart-title { position: absolute; top: 8px; left: 12px; font-size: 12px; color: var(--dim); z-index: 1; }
  .chart-bar { position: absolute; bottom: 30px; border-radius: 3px 3px 0 0; transition: height 0.5s; }
  .chart-label { position: absolute; bottom: 8px; font-size: 9px; color: var(--dim); text-align: center; transform: translateX(-50%); }
  .chart-val { position: absolute; font-size: 9px; color: var(--text); text-align: center; transform: translateX(-50%); }

  .hyp-card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 16px; margin-bottom: 12px; }
  .hyp-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
  .hyp-id { font-size: 12px; font-weight: 700; color: var(--dim); }
  .hyp-badge { padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 600; }
  .hyp-badge.supported { background: rgba(63,185,80,0.15); color: var(--green); }
  .hyp-badge.rejected { background: rgba(248,81,73,0.15); color: var(--red); }
  .hyp-name { font-size: 15px; font-weight: 600; margin-bottom: 4px; }
  .hyp-claim { font-size: 13px; color: var(--dim); margin-bottom: 8px; }
  .hyp-stat { font-size: 12px; color: var(--accent); font-family: 'SF Mono', monospace; }

  .finding { background: rgba(88,166,255,0.05); border-left: 3px solid var(--accent); padding: 12px 16px; margin: 12px 0; border-radius: 0 6px 6px 0; }
  .finding strong { color: var(--accent); }
  .finding p { margin-top: 4px; color: var(--dim); font-size: 13px; }

  .donut-container { display: flex; align-items: center; gap: 24px; margin: 16px 0; }
  .donut { width: 180px; height: 180px; }
  .donut-legend { display: flex; flex-direction: column; gap: 6px; }
  .donut-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
  .donut-swatch { width: 12px; height: 12px; border-radius: 3px; flex-shrink: 0; }

  .report-link { display: inline-block; margin-top: 16px; padding: 8px 16px; background: rgba(88,166,255,0.1); border: 1px solid var(--accent); border-radius: 6px; color: var(--accent); text-decoration: none; font-size: 13px; }
  .report-link:hover { background: rgba(88,166,255,0.2); }

  .accum-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 16px; margin: 16px 0; }
  .accum-card { background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 16px; }
  .accum-card h3 { font-size: 14px; margin-bottom: 12px; }
  .accum-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
  .accum-label { width: 60px; font-size: 12px; color: var(--dim); }
  .accum-bar-wrap { flex: 1; height: 20px; background: rgba(255,255,255,0.05); border-radius: 4px; overflow: hidden; position: relative; }
  .accum-bar-fill { height: 100%; border-radius: 4px; transition: width 0.5s; }
  .accum-val { font-size: 12px; min-width: 50px; text-align: right; font-weight: 600; }
</style>
</head>
<body>
<div class="header">
  <h1>Biodiversity Observations <span>GBIF Global Analysis</span></h1>
  <div class="header-nav">
    <a href="/" id="home-link">Dashboard</a>
    <a href="/climate" id="climate-link">Climate</a>
    <a href="/ocean-warming" id="ocean-link">Ocean</a>
    <a href="/exoplanet-census" id="exo-link">Exoplanets</a>
  </div>
</div>
<div class="container">
  <div id="content"><div class="loading">Loading GBIF biodiversity data...</div></div>
</div>

<script>
const TK='__TOKEN__';
function ap(url){const u=new URL(url,location.origin);if(TK)u.searchParams.set('token',TK);return u.toString();}
document.querySelectorAll('.header-nav a').forEach(a=>{a.href=ap(a.getAttribute('href'));});

function fmt(n){
  if(n>=1e9) return (n/1e9).toFixed(2)+'B';
  if(n>=1e6) return (n/1e6).toFixed(0)+'M';
  if(n>=1e3) return (n/1e3).toFixed(0)+'K';
  return n.toString();
}

async function init(){
  try {
    const res = await fetch(ap('/api/gbif-biodiversity/summary'));
    if(!res.ok) throw new Error('API returned '+res.status);
    const d = await res.json();
    render(d);
  } catch(e) {
    document.getElementById('content').innerHTML='<div class="error">Failed to load data: '+e.message+'</div>';
  }
}

function render(d){
  const h = d.headline_stats;
  let html = '';

  // Stats cards
  html += '<div class="stats-grid">';
  html += card('Total Records', h.total_records_display, '', 'Across '+h.countries+' countries');
  html += card('Growth Since 2000', h.growth_since_2000, 'green', 'Doubling every '+h.doubling_time_years+' years');
  html += card('Citizen Science', h.citizen_science_pct_2024+'%', 'cyan', 'Share of 2024 records');
  html += card('Bird Dominance', h.bird_pct_2024+'%', 'yellow', 'Aves share of 2024 records');
  html += card('Top Country Share', h.top1_country_share+'%', 'purple', 'United States alone');
  html += card('Hypotheses', h.hypotheses_supported, 'green', 'Supported by data');
  html += '</div>';

  // Tabs
  html += '<div class="tabs">';
  html += '<button class="tab active" data-tab="geographic">Geographic Bias</button>';
  html += '<button class="tab" data-tab="taxonomic">Taxonomic Bias</button>';
  html += '<button class="tab" data-tab="temporal">Temporal Growth</button>';
  html += '<button class="tab" data-tab="accumulation">Species Accumulation</button>';
  html += '<button class="tab" data-tab="hypotheses">Hypotheses</button>';
  html += '</div>';

  // Geographic tab
  html += '<div class="tab-panel active" id="tab-geographic">';
  html += renderGeographic(d);
  html += '</div>';

  // Taxonomic tab
  html += '<div class="tab-panel" id="tab-taxonomic">';
  html += renderTaxonomic(d);
  html += '</div>';

  // Temporal tab
  html += '<div class="tab-panel" id="tab-temporal">';
  html += renderTemporal(d);
  html += '</div>';

  // Accumulation tab
  html += '<div class="tab-panel" id="tab-accumulation">';
  html += renderAccumulation(d);
  html += '</div>';

  // Hypotheses tab
  html += '<div class="tab-panel" id="tab-hypotheses">';
  html += renderHypotheses(d);
  html += '</div>';

  // Report link
  html += '<a class="report-link" href="'+ap('/api/file?path=/output/research/gbif-biodiversity/report.md')+'">View Full Report</a>';

  document.getElementById('content').innerHTML = html;

  // Tab switching
  document.querySelectorAll('.tab').forEach(t => {
    t.onclick = () => {
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      document.querySelectorAll('.tab-panel').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      document.getElementById('tab-'+t.dataset.tab).classList.add('active');
    };
  });

  // Section toggling
  document.querySelectorAll('.section-header').forEach(sh => {
    sh.onclick = () => sh.parentElement.classList.toggle('open');
  });
}

function card(label, value, cls, detail){
  return '<div class="stat-card"><div class="label">'+label+'</div><div class="value '+(cls||'')+'">'+value+'</div>'+(detail?'<div class="detail">'+detail+'</div>':'')+'</div>';
}

function renderGeographic(d){
  let html = '';

  // Continental comparison bar chart
  html += '<div class="section open"><div class="section-header"><h2>Continental Distribution</h2><span class="toggle"></span></div><div class="section-body">';
  const colors = ['var(--accent)','var(--purple)','var(--cyan)','var(--yellow)','var(--orange)','var(--red)'];
  const maxRec = Math.max(...d.geographic.continental.map(c=>c.records));
  html += '<table><thead><tr><th>Continent</th><th>Records</th><th style="width:40%">Share</th><th>Density/km\u00B2</th><th>Per Capita</th></tr></thead><tbody>';
  d.geographic.continental.forEach((c,i) => {
    const pct = (c.records/d.headline_stats.total_records*100).toFixed(1);
    const w = (c.records/maxRec*100).toFixed(1);
    html += '<tr><td style="font-weight:600">'+c.continent+'</td><td>'+fmt(c.records)+'</td>';
    html += '<td><div class="bar-container"><div class="bar" style="width:'+w+'%;background:'+colors[i%6]+'"></div><span class="bar-label">'+pct+'%</span></div></td>';
    html += '<td>'+c.density.toFixed(1)+'</td><td>'+c.per_capita.toFixed(2)+'</td></tr>';
  });
  html += '</tbody></table>';
  html += '<div class="finding"><strong>North America + Europe = 79.6%</strong> of all records despite having far less biodiversity than the tropics.<p>Africa\'s 52 countries collectively contribute just 2.5% of records with an observation density 23x lower than North America.</p></div>';
  html += '</div></div>';

  // Top countries
  html += '<div class="section open"><div class="section-header"><h2>Top 10 Countries</h2><span class="toggle"></span></div><div class="section-body">';
  const maxC = d.geographic.top_countries[0].records;
  html += '<table><thead><tr><th>#</th><th>Country</th><th>Records</th><th style="width:40%">Share</th></tr></thead><tbody>';
  d.geographic.top_countries.forEach((c,i) => {
    const w = (c.records/maxC*100).toFixed(1);
    html += '<tr><td>'+(i+1)+'</td><td style="font-weight:600">'+c.name+'</td><td>'+fmt(c.records)+'</td>';
    html += '<td><div class="bar-container"><div class="bar" style="width:'+w+'%;background:var(--accent)"></div><span class="bar-label">'+c.share+'%</span></div></td></tr>';
  });
  html += '</tbody></table>';
  html += '<div class="finding"><strong>Top 10 countries hold 73.6%</strong> of all 3.73 billion records. The US alone has 34.8%.</div>';
  html += '</div></div>';

  return html;
}

function renderTaxonomic(d){
  let html = '';

  // Kingdom breakdown
  html += '<div class="section open"><div class="section-header"><h2>Kingdom Breakdown</h2><span class="toggle"></span></div><div class="section-body">';
  const kColors = ['var(--accent)','var(--green)','var(--yellow)','var(--purple)','var(--dim)'];
  html += '<div class="donut-container"><svg class="donut" viewBox="0 0 42 42">';
  let offset = 0;
  d.taxonomic.kingdoms.forEach((k,i) => {
    const stroke = kColors[i % kColors.length];
    const dash = k.pct + ' ' + (100 - k.pct);
    html += '<circle cx="21" cy="21" r="15.9" fill="none" stroke="'+stroke+'" stroke-width="5" stroke-dasharray="'+dash+'" stroke-dashoffset="-'+offset+'" />';
    offset += k.pct;
  });
  html += '</svg><div class="donut-legend">';
  d.taxonomic.kingdoms.forEach((k,i) => {
    html += '<div class="donut-item"><div class="donut-swatch" style="background:'+kColors[i%kColors.length]+'"></div>'+k.name+' ('+k.pct+'%)</div>';
  });
  html += '</div></div>';
  html += '<div class="finding"><strong>Animalia (78.8%)</strong> dominates GBIF. Within Animalia, birds alone are 78.4% \u2014 meaning <strong>one class (Aves) is 61.8% of the entire database</strong>.</div>';
  html += '</div></div>';

  // Bird share trend
  html += '<div class="section open"><div class="section-header"><h2>Bird Share Over Time (H3)</h2><span class="toggle"></span></div><div class="section-body">';
  html += '<div class="chart" style="height:220px"><div class="chart-title">Aves as % of annual records</div>';
  const trend = d.taxonomic.bird_share_trend;
  const barW = 80 / trend.length;
  trend.forEach((pt,i) => {
    const h = pt.pct / 100 * 160;
    const left = 10 + i * (80/trend.length) + barW/2;
    const hue = pt.pct > 70 ? 'var(--yellow)' : pt.pct > 50 ? 'var(--orange)' : 'var(--green)';
    html += '<div class="chart-bar" style="left:'+left+'%;width:'+(barW*0.7)+'%;height:'+h+'px;background:'+hue+'"></div>';
    html += '<div class="chart-label" style="left:'+(left+barW*0.35)+'%">'+pt.year+'</div>';
    html += '<div class="chart-val" style="left:'+(left+barW*0.35)+'%;bottom:'+(h+35)+'px">'+pt.pct+'%</div>';
  });
  html += '</div>';
  html += '<div class="finding"><strong>Bird share doubled from 38.6% to 82.8%</strong> (2000-2024). Driven by eBird, this represents a +44 percentage point shift. GBIF is increasingly becoming a bird database.</div>';
  html += '</div></div>';

  return html;
}

function renderTemporal(d){
  let html = '';

  // Growth curve
  html += '<div class="section open"><div class="section-header"><h2>Annual Record Growth</h2><span class="toggle"></span></div><div class="section-body">';
  const gc = d.temporal.growth_curve;
  const maxGc = Math.max(...gc.map(p=>p.records));
  html += '<div class="chart" style="height:250px"><div class="chart-title">Annual GBIF records (millions)</div>';
  const gcW = 80 / gc.length;
  gc.forEach((pt,i) => {
    const h = pt.records / maxGc * 190;
    const left = 10 + i * gcW + gcW/2;
    html += '<div class="chart-bar" style="left:'+left+'%;width:'+(gcW*0.6)+'%;height:'+h+'px;background:var(--accent)"></div>';
    html += '<div class="chart-label" style="left:'+(left+gcW*0.3)+'%">'+pt.year+'</div>';
    html += '<div class="chart-val" style="left:'+(left+gcW*0.3)+'%;bottom:'+(h+35)+'px">'+fmt(pt.records)+'</div>';
  });
  html += '</div>';
  html += '<div class="finding"><strong>13.1x growth since 2000</strong>. Doubling every 5.9 years (R\u00B2 = 0.994). From 25.5M records/year in 2000 to 333.5M in 2024.</div>';
  html += '</div></div>';

  // Citizen science
  html += '<div class="section open"><div class="section-header"><h2>Citizen Science Revolution</h2><span class="toggle"></span></div><div class="section-body">';
  const cs = d.temporal.citizen_science_trend;
  html += '<table><thead><tr><th>Year</th><th>Citizen Science %</th><th style="width:50%">Share</th></tr></thead><tbody>';
  cs.forEach(pt => {
    html += '<tr><td>'+pt.year+'</td><td style="font-weight:600">'+pt.pct+'%</td>';
    html += '<td><div class="bar-container"><div class="bar" style="width:'+pt.pct+'%;background:var(--cyan)"></div></div></td></tr>';
  });
  html += '</tbody></table>';
  html += '<div class="finding"><strong>97.8% citizen science in 2024</strong>. GBIF has transformed from a museum specimen repository into a platform for real-time citizen observations, overwhelmingly of birds.</div>';
  html += '</div></div>';

  return html;
}

function renderAccumulation(d){
  let html = '';

  html += '<div class="section open"><div class="section-header"><h2>Species Discovery Rates (H4)</h2><span class="toggle"></span></div><div class="section-body">';
  html += '<p style="color:var(--dim);margin-bottom:16px;font-size:13px">Comparing bird vs. insect species accumulation (2005-2024) to test whether bird inventories are saturating while insect discovery continues.</p>';

  html += '<div class="accum-grid">';
  const countries = {US:'United States', GB:'United Kingdom', AU:'Australia'};
  const maxGrowth = 145.5;
  for(const [code,name] of Object.entries(countries)){
    const acc = d.accumulation[code];
    html += '<div class="accum-card"><h3>'+name+'</h3>';
    // Birds
    html += '<div class="accum-row"><div class="accum-label">Birds</div>';
    html += '<div class="accum-bar-wrap"><div class="accum-bar-fill" style="width:'+(acc.birds_growth/maxGrowth*100)+'%;background:var(--yellow)"></div></div>';
    html += '<div class="accum-val" style="color:var(--yellow)">+'+acc.birds_growth+'%</div></div>';
    // Insects
    html += '<div class="accum-row"><div class="accum-label">Insects</div>';
    html += '<div class="accum-bar-wrap"><div class="accum-bar-fill" style="width:'+(acc.insects_growth/maxGrowth*100)+'%;background:var(--green)"></div></div>';
    html += '<div class="accum-val" style="color:var(--green)">+'+acc.insects_growth+'%</div></div>';
    html += '</div>';
  }
  html += '</div>';

  html += '<div class="finding"><strong>Bird inventories are nearly complete</strong> (5-9% growth), while insect species counts continue to climb steeply (18-146% growth). In Australia, insect species in GBIF grew 26x faster than bird species. Each new insect observation is far more likely to represent a new species than each new bird observation.</div>';
  html += '</div></div>';

  return html;
}

function renderHypotheses(d){
  let html = '';
  d.hypotheses.forEach(h => {
    html += '<div class="hyp-card">';
    html += '<div class="hyp-header"><span class="hyp-id">'+h.id+'</span><span class="hyp-badge '+(h.supported?'supported':'rejected')+'">'+h.result+'</span></div>';
    html += '<div class="hyp-name">'+h.name+'</div>';
    html += '<div class="hyp-claim">'+h.claim+'</div>';
    html += '<div class="hyp-stat">'+h.stat+'</div>';
    html += '</div>';
  });
  html += '<div class="finding"><strong>3 of 5 hypotheses supported.</strong><p>The strongest findings: bird taxonomic bias is worsening dramatically (H3), bird and insect inventories are at fundamentally different stages (H4), and GBIF membership is associated with higher observation rates (H5). Geographic inequality is extreme but stable (H2 not supported), and the tropical paradox is not a simple inverse relationship (H1 not supported).</p></div>';
  return html;
}

init();
</script>
</body>
</html>
